

# 后端服务器

![code](https://img.shields.io/badge/codecov-0%25-green)![build](https://img.shields.io/badge/build-django-red)![mode](https://img.shields.io/badge/mode-MVT-important)

## 主要功能：

- 针对小程序的药品进行管理（完成）
- 对传感器上传来的数据进行处理（待定）



## 安装

使用django构建后端服务器，数据库使用mysql，数据来源于网络爬虫

项目已经开始，已经完成了基础的功能，下一步则是与硬件交互 



## 配置

配置都是在`settings.py`中的

全部配置都已经提交，可再`settings.py`中查看



## 创建数据库

```mysql
CREATE DATABASE `medical` CHARACTER SET 'utf8'
```

然后终端执行

```shell
./manage.py makemigrations
./manage.py migrate
```

### 创建超级用户

终端下执行:

```
./manage.py createsuperuser
```

### 创建测试数据

终端下执行:

```
./manage.py create_testdata
```

### 收集静态文件

终端下执行:  

```
./manage.py collectstatic --noinput
./manage.py compress --force
```

### 开始运行：

执行： `./manage.py runserver`

浏览器打开: http://127.0.0.1:8000/ 就可以看到效果了。



# API文档

> 在本文档的API中，请求体中的数据需要以**`json`**格式发送到后端
>
> 所有的API本地IP为：172.16.176.120:8000
>
> ​				 线上IP为：120.78.168.67:9876
>
> ​				线上API域名：api.sunshinego.online:9876

## 微信小程序API文档



### 1、创建用户/用户登录

> 请求方式

| 选项     | 方案                                      |
| -------- | ----------------------------------------- |
| 请求方法 | GET                                       |
| 请求地址 | api.sunshinego.online:9876/loginORcreate/ |

> 请求参数：请求体中（json）

| 参数名   | 类型   | 是否必传 | 说明                    |
| -------- | ------ | -------- | ----------------------- |
| name     | string | 否       | 用户名称                |
| sex      | Bool   | 否       | 用户性别(0:man, 1woman) |
| age      | int    | 否       | 用户年龄                |
| weight   | int    | 否       | 用户体重(格式：120)     |
| height   | string | 否       | 用户身高(格式：1.70)    |
| health   | string | 否       | 用户健康状况            |
| contacts | int    | 否       | 应急联系人              |
| code     | string | 是       | 临时登录凭证            |
| token    | string | 否       | 用户唯一标识            |
| birthday | string | 否       | 用户生日                |
| phone    | string | 否       | 用户电话                |

| 传入token       | 用户登录                 |
| --------------- | ------------------------ |
| **未传入token** | **用户创建(需传入code)** |



> 相应结果

```json
{
    "code": 0,
    "token": "1840707266",
    "errmsg": "登录成功"
} 
```

### 2、修改用户信息

> 请求方式

| 选项     | 方案                                      |
| -------- | ----------------------------------------- |
| 请求方法 | PUT                                       |
| 请求地址 | api.sunshinego.online:9876/loginORcreate/ |

> 请求参数：请求体中（json）

| 参数名   | 类型   | 是否必传 | 说明                    |
| -------- | ------ | -------- | ----------------------- |
| name     | string | 否       | 用户名称                |
| sex      | Bool   | 否       | 用户性别(0:man, 1woman) |
| age      | int    | 否       | 用户年龄                |
| weight   | int    | 否       | 用户体重                |
| height   | string | 否       | 用户身高(格式：1.70)    |
| health   | string | 否       | 用户健康状况            |
| contacts | int    | 否       | 应急联系人              |
| token    | string | 是       | 用户唯一标识            |

> 相应结果

```json
{
    "code": 0,
    "errmsg": "修改成功"
} 
```



### 3、获取用户信息

> 请求方式

| 选项     | 方案                                      |
| -------- | ----------------------------------------- |
| 请求方法 | GET                                       |
| 请求地址 | api.sunshinego.online:9876/showuser/token |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明           |
| ------ | ------ | -------- | -------------- |
| token  | String | 是       | 用户的唯一标识 |

> 相应结果

```json
{
    "code": "0",
    "errmsg": "ok",
    "message": {
        "name": null,
        "sex": 0,
        "age": 56,
        "weight": null,
        "height": "1.70",
        "health": "健康的一批",
        "contacts": null
    }
}
```

```
name		姓名
sex			性别(0:man, 1woman)
age			年龄
weight		体重
height		身高
health		健康状况
contacts	紧急联系人
```

### 4、添加药品

> 请求方式

| 选项     | 方案                                              |
| -------- | ------------------------------------------------- |
| 请求方法 | GET                                               |
| 请求地址 | api.sunshinego.online:9876/medical/name/token/num |

> 请求参数：查询字符串参数以及路径参数

| 参数名     | 类型   | 是否必传 | 说明                                 |
| ---------- | ------ | -------- | ------------------------------------ |
| name       | string | 是       | 药品名称，本参数为***路径参数***     |
| token      | string | 是       | 用户唯一标识，本参数为***路径参数*** |
| num        | string | 是       | 选择添加药箱编号***路径参数***       |
| category   | string | 否       | 药品类别                             |
| introduce  | string | 否       | 药品简介                             |
| suit       | string | 否       | 适应症状                             |
| bad        | string | 否       | 不良反应                             |
| life       | int    | 否       | 保质期                               |
| use        | string | 否       | 使用方法                             |
| taboo      | string | 否       | 禁忌                                 |
| heed       | string | 否       | 注意事项                             |
| savemethod | string | 否       | 保存方法                             |





> 相应结果

```json
{
    "code": 0,
    "errmsg": "ok"
} 
```

### 5、修改药品信息

> 请求方式

| 选项     | 方案                                              |
| -------- | ------------------------------------------------- |
| 请求方法 | PUT                                               |
| 请求地址 | api.sunshinego.online:9876/medical/name/token/num |

> 请求参数：请求体中（json）以及路径参数

| 参数名     | 类型   | 是否必传 | 说明                                      |
| ---------- | ------ | -------- | ----------------------------------------- |
| name       | string | 是       | 要修改的药品名，本参数为***路径参数***    |
| newname    | string | 是       | 药品修改后的名字（如果不修改名字，传入0） |
| token      | string | 是       | 用户唯一标识，本参数为***路径参数***      |
| newnum     | string | 是       | 选择添加药箱编号                          |
| category   | string | 否       | 药品类别                                  |
| introduce  | string | 否       | 药品简介                                  |
| suit       | string | 否       | 适应症状                                  |
| bad        | string | 否       | 不良反应                                  |
| life       | int    | 否       | 保质期                                    |
| use        | string | 否       | 使用方法                                  |
| taboo      | string | 否       | 禁忌                                      |
| heed       | string | 否       | 注意事项                                  |
| savemethod | string | 否       | 保存方法                                  |

> 相应结果

```json
{
    "code": 0,
    "errmsg": "ok"
} 
```

### 6、获取用户药品信息

> 请求方式

| 选项     | 方案                                         |
| -------- | -------------------------------------------- |
| 请求方法 | GET                                          |
| 请求地址 | api.sunshinego.online:9876/showmedical/token |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明           |
| ------ | ------ | -------- | -------------- |
| token  | string | 是       | 用户的唯一标识 |

> 相应结果

```json
{
    "code": "0",
    "errmsg": "ok",
    "data": {
        "0": [
            {
                "name": "阿司匹林",
                "category": null,
                "introduce": null,
                "suit": null,
                "bad": null,
                "life": 5,
                "use": null,
                "taboo": null,
                "heed": null,
                "savemethod": null,
                "num": 1
            }
        ],
        "1": [
            {
                "name": "阿莫西林",
                "category": null,
                "introduce": null,
                "suit": null,
                "bad": null,
                "life": 1,
                "use": null,
                "taboo": null,
                "heed": null,
                "savemethod": null,
                "num": 1
            }
        ],
        "2": [
            {
                "name": "奥美拉唑",
                "category": "",
                "introduce": "",
                "suit": "",
                "bad": "",
                "life": 12,
                "use": "",
                "taboo": "",
                "heed": "",
                "savemethod": "",
                "num": 1
            }
        ],
        "3": [
            {
                "name": "aaaaa",
                "category": "",
                "introduce": "",
                "suit": "",
                "bad": "",
                "life": 12,
                "use": "",
                "taboo": "",
                "heed": "",
                "savemethod": "",
                "num": 1
            }
        ],
        "4": [
            {
                "name": "bbb",
                "category": null,
                "introduce": null,
                "suit": null,
                "bad": null,
                "life": null,
                "use": null,
                "taboo": null,
                "heed": null,
                "savemethod": null,
                "num": 1
            }
        ]
    }
}
```

### 7、获取程序自带药品信息

> 请求方式

| 选项     | 方案                               |
| -------- | ---------------------------------- |
| 请求方法 | GET                                |
| 请求地址 | api.sunshinego.online:9876/showall |

> 请求参数：无

> 相应结果

```json
{
    "code": "0",
    "errmsg": "ok",
    "data": {
        "0": "阿莫西林",
        "1": "阿司匹林",
        "2": "青霉素"
    }
}
```

### 8、查询药品（旧|满）

> 请求方式

| 选项     | 方案                                    |
| -------- | --------------------------------------- |
| 请求方法 | GET                                     |
| 请求地址 | api.sunshinego.online:9876/search2/name |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明       |
| ------ | ------ | -------- | ---------- |
| name   | string | 是       | 查询药品名 |

> 相应结果
>
> 注：有些药品的属性没有，则会返回null

![image-20210419002423268](.\imgs\image-20210419002423268.png)

```json
{
    {
    "show": {
        "img": "https://img.familydoctor.com.cn/uploadimg/kuweb/2016/10/08/12/918d4ea457010000ab7059402e220000.jpeg",
        "name": "君尔清（阿莫西林克拉维酸钾片）"
    },
    "msg": {
        "name": "君尔清(阿莫西林克拉维酸钾片)",
        "suit": [
            "本品适用于敏感菌引起的各种感染，如：",
            "1上呼吸道感染：鼻窦炎、扁桃体炎、咽炎等。",
            "2下呼吸道感染：急性支气管炎、慢性支气管炎急性发作、肺炎、肺脓肿和支气管合并感染等。",
            "3泌尿系统感染：膀胱炎、尿道炎、肾盂肾炎、前列腺炎、盆腔炎、淋病奈瑟菌尿路感染及软性下疳等。",
            "4皮肤和软组织感染：疖、脓肿、蜂窝组织炎、伤口感染、腹内脓毒症等。",
            "5其他感染：中耳炎、骨髓炎、败血症、腹膜炎和手术后感染等。由氨苄青霉素"
        ],
        "usemethod": [
            "成人及大于12岁儿童，一般每次1片，一日三次；严重感染时，剂量可加倍或遵医嘱。未经重新检查，连续治疗期不超过14天。对于肾功能受损患者：肾功能受损的病人（肌酐消除率＞30ml/min）一般不要求减少剂量；严重肾功能受损的病人，肌酐消除率在＜30ml/min者，应适当减少剂量，延长给药间隔。血液透析患者在透析结束后应加服一次。"
        ],
        "lelment": "本品为复方制剂，其组份为：每片含阿莫西林0.250g与克拉维酸0.125g。",
        "bad": [
            "1常见胃肠道反应如腹泻、恶心和呕吐等。",
            "2皮疹，尤其易发生于传染性单核细胞增多症者。",
            "3可见过敏性休克、药物热和哮喘等。",
            "4偶见血清氨基转移酶升高、嗜酸性粒细胞增多、白细胞降低及念珠菌或耐药菌引起的二重感染。"
        ],
        "err": [
            "青霉素皮试阳性反应者、对本品及其他青霉素类药物过敏者及传染性单核细胞增多症患者禁用。"
        ],
        "heed": [
            "1、患者每次开始服用本品前，必须先进行青霉素皮试。",
            "2、对头孢菌素类药物过敏者及有哮喘、湿疹、枯草热、荨麻疹等过敏性疾病史和严重肝功能障碍者慎用。",
            "3、本品与其他青霉素类和头孢菌素类药物之间有交叉过敏性。若有过敏反应产生，则应立即停用本品，并采取相应措施。",
            "4、本品和氨苄西林有完全交叉耐药性，与其他青霉素类和头孢菌素类有交叉耐药性。",
            "5、肾功能减退者应根据血浆肌酐清除率调整剂量或给药间期；血液透析可影响本品中阿莫西林的血药浓度，因此在血液透析过程中及结束时应加服本品1次。",
            "6、对怀疑为伴梅毒损害之淋病患者，在使用本品前应进行暗视野检查，并至少在4个月内，每月接受血清试验一次。",
            "7、严重肝功能减退者慎用。长期或大剂量服用本品者，应定期检查肝、肾、造血系统功能和检测血清钾或钠。",
            "8、对实验室检查指标的干扰：（1）硫酸铜法尿糖试验可呈假阳性，但葡萄糖酶试验法不受影响；（2）可使血清丙氨酸氨基转移酶或门冬氨酸氨基转移酶测定值升高。"
        ],
        "savemethod": "在凉暗（避光并不超过20℃）干燥处保存。"
    }
}
```



### 9、查询药品（精准|单个）

> 请求方式

| 选项     | 方案                                   |
| -------- | -------------------------------------- |
| 请求方法 | GET                                    |
| 请求地址 | api.sunshinego.online:9876/search/name |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明         |
| ------ | ------ | -------- | ------------ |
| name   | string | 是       | 查询药品名   |
| num    | int    | 是       | 查询的序列号 |

> 这里的num是上面模糊查询的序列号，标识第几个。
>
> 相应结果
>
> 注：有些药品的属性没有，则会返回null





### 10、查询药品（新|多个）

> 请求方式

| 选项     | 方案                                  |
| -------- | ------------------------------------- |
| 请求方法 | GET                                   |
| 请求地址 | api.sunshinego.online:9876/show2/name |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明       |
| ------ | ------ | -------- | ---------- |
| name   | string | 是       | 查询药品名 |

> 这个会查询数据库里的药品，如果有--->返回数据库里的数据
>
> ​													没有---->数据爬到数据库里，返回数据
>
> 返回相应：

```json
{
    "code": "0",
    "errmsg": "已存储到数据库",
    "data": {
        "id": 244,
        "name": "阿莫西林克拉维酸钾片",
        "num": 8,
        "img_url": "https://ypk.familydoctor.com.cn/uploadFile/20141231/medicine/20141229043925644065.gif",
        "suit": "['本品适用于敏感菌引起的各种感染，如：', '1上呼吸道感染：鼻窦炎、扁桃体炎、咽炎等。', '2下呼吸道感染：急性支气管炎、慢性支气管炎急性发作、肺炎、肺脓肿和支气管合并感染等。', '3泌尿系统感染：膀胱炎、尿道炎、肾盂肾炎、前列腺炎、盆腔炎、淋病奈瑟菌尿路感染及软性下疳等。', '4皮肤和软组织感染：疖、脓肿、蜂窝组织炎、伤口感染、腹内脓毒症等。', '5其他感染：中耳炎、骨髓炎、败血症、腹膜炎和手术后感染等。由氨苄青霉素']",
        "usemethod": "['成人及大于12岁儿童，一般每次1片，一日三次；严重感染时，剂量可加倍或遵医嘱。未经重新检查，连续治疗期不超过14天。对于肾功能受损患者：肾功能受损的病人（肌酐消除率＞30ml/min）一般不要求减少剂量；严重肾功能受损的病人，肌酐消除率在＜30ml/min者，应适当减少剂量，延长给药间隔。血液透析患者在透析结束后应加服一次。']",
        "lelment": "本品为复方制剂，其组分为阿莫西林和克拉维酸钾（4：1）。",
        "bad": "['1常见胃肠道反应如腹泻、恶心和呕吐等。', '2皮疹，尤其易发生于传染性单核细胞增多症者。', '3可见过敏性休克、药物热和哮喘等。', '4偶见血清氨基转移酶升高、嗜酸性粒细胞增多、白细胞降低及念珠菌或耐药菌引起的二重感染。', '5中枢神经系统：偶见头痛，罕见失眠、焦虑、行为异常。对氨苄西林类抗生素可能发生的不良反应均应注意。']",
        "err": "['青霉素皮试阳性反应者、对本品及其他青霉素类药物过敏者及传染性单核细胞增多症患者禁用。']",
        "heed": "['1患者每次开始服用本品前，必须先进行青霉素皮试。', '2对头孢菌素类药物过敏者及有哮喘、湿疹、枯草热、荨麻疹等过敏性疾病史和严重肝功能障碍者慎用。', '3本品与其他青霉素类和头孢菌素类药物之间有交叉过敏性。若有过敏反应产生，则应立即停用本品，并采取相应措施。', '4本品和氨苄西林有完全交叉耐药性，与其他青霉素类和头孢菌素类有交叉耐药性。', '5肾功能减退者应根据血浆肌酐清除率调整剂量或给药间期；血液透析可影响本品中阿莫西林的血药浓']",
        "savemethod": "密封，在凉暗干燥处保存。有效期：24个月",
        "medical_id": 10
	},
	{
        ......
    }
}
```

> 注：这里的num是和实时爬虫里的num一样的，是查询的序列号，标识第几个。



### 11、删除药品信息

> 请求方式

| 选项     | 方案                                         |
| -------- | -------------------------------------------- |
| 请求方法 | GET                                          |
| 请求地址 | api.sunshinego.online:9876/delete/name/token |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明         |
| ------ | ------ | -------- | ------------ |
| name   | string | 是       | 删除药品名   |
| token  | string | 是       | 用户唯一标识 |

> 相应结果

```json
{
    "code": "0",
    "errmsg": "ok",
}
```





### 12、过期检测

> 请求方式

| 选项     | 方案                                  |
| -------- | ------------------------------------- |
| 请求方法 | GET                                   |
| 请求地址 | api.sunshinego.online:9876/time/token |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明     |
| ------ | ------ | -------- | -------- |
| token  | string | 是       | 用户标识 |

> 相应结果
>
> 有过期的药品

```json
{
    "code": "0",
    "errmsg": "ok",
    "data": {
        "0": {
            "msg": "已经过期29天了",
            "name": "阿莫西林",
            "data": -29
        }
    }
}
```

> 没有过期的药品

```json
{
    "code": "1",
    "errmsg": "没有过期的药品"
}
```



### 13、在线人数统计

> 请求方式

| 选项     | 方案                             |
| -------- | -------------------------------- |
| 请求方法 |                                  |
| 请求地址 | api.sunshinego.online:9876/live/ |

> 请求参数：请求体中
>
> condition为login是登录；exit为登出

| 参数名    | 类型   | 是否必传 | 说明         |
| --------- | ------ | -------- | ------------ |
| token     | string | 是       | 用户标识     |
| condition |        | 是       | 区分登录登出 |

> 相应结果
>

```json
{
    "code": "0",
    "errmsg": "test1111登录成功"
}
```

```json
{
    "code": "0",
    "errmsg": "test1111登出成功"
}
```



### 14、全国疫情数据可视化大屏

> 请求方式

| 选项     | 方案                            |
| -------- | ------------------------------- |
| 请求方法 | GET                             |
| 请求地址 | api.sunshinego.online:9876/mao/ |

> 相应结果

![image-20210706234830899](C:\Users\SunShineGO\AppData\Roaming\Typora\typora-user-images\image-20210706234830899.png)

## 后台API文档

### 1、注册人数

> 请求方式

| 选项     | 方案                               |
| -------- | ---------------------------------- |
| 请求方法 | GET                                |
| 请求地址 | api.sunshinego.online:9876/usernum |

> 请求参数：无

> 相应结果
>

```json
{
    "code": "0",
    "num": 1
}
```



### 2、会员信息管理（删）

> 请求方式

| 选项     | 方案                            |
| -------- | ------------------------------- |
| 请求方法 | DELETE                          |
| 请求地址 | api.sunshinego.online:9876/user |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明     |
| ------ | ------ | -------- | -------- |
| token  | string | 是       | 用户标识 |

> 相应结果
>
> 有过期的药品

```json
{
    "code": "0",
    "errmsg": "删除成功",
}
```



### 3、会员信息管理（改）

> 请求方式

| 选项     | 方案                            |
| -------- | ------------------------------- |
| 请求方法 | PUT                             |
| 请求地址 | api.sunshinego.online:9876/user |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明     |
| ------ | ------ | -------- | -------- |
| token  | string | 是       | 用户标识 |

> 相应结果
>
> 有过期的药品

> 

```json
{
    "code": "0",
    "errmsg": "修改成功",
}
```



### 4、会员信息管理（查）

> 请求方式

| 选项     | 方案                            |
| -------- | ------------------------------- |
| 请求方法 | GET                             |
| 请求地址 | api.sunshinego.online:9876/user |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明     |
| ------ | ------ | -------- | -------- |
| token  | string | 否       | 用户标识 |

> 相应结果
>
> 有过期的药品



> 注：如果没有传入token，默认返回所有用户信息

```json
{
    "code": "0",
    "errmsg": "ok",
    "data": {
        "1": {
            "sex": null,
            "age": 55,
            "weigth": null,
            "height": null,
            "health": null,
            "contacts": null,
            "creat_data": "0000-00-00",
            "name": null,
            "birthday": null,
            "phone": null
        }
    }
}
```

### 5、用户收藏药品信息

> 请求方式

| 选项     | 方案                                   |
| -------- | -------------------------------------- |
| 请求方法 | GET                                    |
| 请求地址 | api.sunshinego.online:9876/usercollect |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明     |
| ------ | ------ | -------- | -------- |
| token  | string | 是       | 用户标识 |

> 响应结果
>

```json
{
    "code": "0",
    "errmsg": "ok",
    "data": {
        "1": {
            "name": "阿司匹林",
            "category": "",
            "introduce": "",
            "creat_data": "2021-05-08",
            "suit": "",
            "bad": "",
            "life": 5,
            "use": "",
            "taboo": "hh",
            "heed": "",
            "savemethod": "",
            "medicalkit": 1
        },
        "2": {
            "name": "阿莫西林",
            "category": "",
            "introduce": "",
            "creat_data": "2021-03-08",
            "suit": "",
            "bad": "",
            "life": 1,
            "use": "sss",
            "taboo": "",
            "heed": "aa",
            "savemethod": "",
            "medicalkit": 1
        },
        "3": {
            "name": "test",
            "category": "",
            "introduce": "",
            "creat_data": "2021-05-21",
            "suit": "",
            "bad": "",
            "life": 12,
            "use": "",
            "taboo": "",
            "heed": "",
            "savemethod": "",
            "medicalkit": 1
        },
        "4": {
            "name": "1",
            "category": "1",
            "introduce": "01",
            "creat_data": "2021-05-28",
            "suit": "11",
            "bad": "11",
            "life": 1,
            "use": "1",
            "taboo": "11",
            "heed": "1",
            "savemethod": "1",
            "medicalkit": 3
        }
    }
}
```



### 6、在线人数统计

> 请求方式

| 选项     | 方案                            |
| -------- | ------------------------------- |
| 请求方法 | GET                             |
| 请求地址 | api.sunshinego.online:9876/live |

> 请求参数：路径参数

| 参数名 | 类型   | 是否必传 | 说明     |
| ------ | ------ | -------- | -------- |
| token  | string | 是       | 用户标识 |

> 响应结果

```json
{
    "code": "0",
    "errmsg": "ok",
    "data": 1
}
```

